<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>c&#39;t-Bot: behaviour_scan_beacons.c Quellcode</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />



</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">c&#39;t-Bot
   &#160;<span id="projectnumber">1898</span>
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Erzeugt von Doxygen 1.7.5.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Hauptseite</span></a></li>
      <li><a href="pages.html"><span>Zus√§tzliche&#160;Informationen</span></a></li>
      <li><a href="annotated.html"><span>Datenstrukturen</span></a></li>
      <li class="current"><a href="files.html"><span>Dateien</span></a></li>
      <li><a href="dirs.html"><span>Verzeichnisse</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>Auflistung&#160;der&#160;Dateien</span></a></li>
      <li><a href="globals.html"><span>Datei-Elemente</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_14c9cc1c75a92f359ad94591d62973a1.html">bot-logic</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">behaviour_scan_beacons.c</div>  </div>
</div>
<div class="contents">
<a href="behaviour__scan__beacons_8c.html">gehe zur Dokumentation dieser Datei</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * c&#39;t-Bot</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This program is free software; you can redistribute it</span>
<a name="l00005"></a>00005 <span class="comment"> * and/or modify it under the terms of the GNU General</span>
<a name="l00006"></a>00006 <span class="comment"> * Public License as published by the Free Software</span>
<a name="l00007"></a>00007 <span class="comment"> * Foundation; either version 2 of the License, or (at your</span>
<a name="l00008"></a>00008 <span class="comment"> * option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment"> * This program is distributed in the hope that it will be</span>
<a name="l00010"></a>00010 <span class="comment"> * useful, but WITHOUT ANY WARRANTY; without even the implied</span>
<a name="l00011"></a>00011 <span class="comment"> * warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR</span>
<a name="l00012"></a>00012 <span class="comment"> * PURPOSE. See the GNU General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment"> * You should have received a copy of the GNU General Public</span>
<a name="l00014"></a>00014 <span class="comment"> * License along with this program; if not, write to the Free</span>
<a name="l00015"></a>00015 <span class="comment"> * Software Foundation, Inc., 59 Temple Place, Suite 330, Boston,</span>
<a name="l00016"></a>00016 <span class="comment"> * MA 02111-1307, USA.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> */</span>
<a name="l00019"></a>00019 
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="bot-logic_8h.html" title="High-Level-Routinen fuer die Steuerung des c&#39;t-Bots.">bot-logic/bot-logic.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#ifdef BEHAVIOUR_SCAN_BEACONS_AVAILABLE</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="log_8h.html" title="Routinen zum Loggen von Informationen.">log.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="math__utils_8h.html" title="Hilfsfunktionen fuer mathematische Dinge, architekturunabhaengig.">math_utils.h</a>&quot;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">static</span> uint8_t state;       
<a name="l00037"></a>00037 <span class="keyword">static</span> uint8_t pos_update;  
<a name="l00038"></a>00038 <span class="keyword">static</span> uint8_t turn_mode;   
<a name="l00039"></a>00039 <span class="keyword">static</span> uint8_t beacon_index;
<a name="l00040"></a>00040 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00041"></a><a class="code" href="behaviour__scan__beacons_8c.html#a4fc3a0c58dfbd1e68224521185cb9384">00041</a>     uint16_t <a class="code" href="behaviour__scan__beacons_8c.html#a4fc3a0c58dfbd1e68224521185cb9384">id</a>;                    
<a name="l00042"></a><a class="code" href="behaviour__scan__beacons_8c.html#ac5682e48513a771560df50e3b213e61a">00042</a>     <span class="keywordtype">float</span> <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a>;                  
<a name="l00043"></a>00043 } recognized_beacons[3];            
<a name="l00044"></a>00044 <span class="keyword">static</span> <span class="keywordtype">float</span> appearance_heading;    
<a name="l00045"></a>00045 <span class="keyword">static</span> <span class="keywordtype">float</span> last_beacon_heading;   
<a name="l00046"></a>00046 <span class="keyword">static</span> <span class="keywordtype">float</span> last_heading;          
<a name="l00047"></a>00047 <span class="keyword">static</span> <span class="keywordtype">float</span> turned;                
<a name="l00049"></a><a class="code" href="behaviour__scan__beacons_8c.html#a82629da0b77dd188aa31e51bca0b8567">00049</a> <span class="preprocessor">#define MAX_BEACONS (sizeof(recognized_beacons) / sizeof(recognized_beacons[0]))</span>
<a name="l00050"></a><a class="code" href="behaviour__scan__beacons_8c.html#ad3732e0758d4aab3d0fb15edd48e0c6f">00050</a> <span class="preprocessor"></span><span class="preprocessor">#define BEACON_GRID_SIZE        240 </span>
<a name="l00052"></a><a class="code" href="behaviour__scan__beacons_8c.html#a62cdd89b7410c37225ca8abfc5251dde">00052</a> <span class="preprocessor">#define SEARCH_APPEARANCE       0   </span>
<a name="l00053"></a><a class="code" href="behaviour__scan__beacons_8c.html#accfb105ababa082863cb333c798a171f">00053</a> <span class="preprocessor">#define SEARCH_DISAPPEARANCE    1   </span>
<a name="l00054"></a><a class="code" href="behaviour__scan__beacons_8c.html#a9316b310ba918215b85c94167fce3659">00054</a> <span class="preprocessor">#define CALC_POSITION           2   </span>
<a name="l00055"></a><a class="code" href="behaviour__scan__beacons_8c.html#a29fd18bed01c4d836c7ebfe73a125c3f">00055</a> <span class="preprocessor">#define END                     99  </span>
<a name="l00062"></a>00062 <span class="preprocessor">static position_t get_position_from_id(uint16_t id) {</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>    position_t pos = {0, 0};
<a name="l00064"></a>00064 <span class="preprocessor">#ifdef PC</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>    pos.x = (<span class="keywordtype">id</span> &gt;&gt; 8) * <a class="code" href="behaviour__scan__beacons_8c.html#ad3732e0758d4aab3d0fb15edd48e0c6f">BEACON_GRID_SIZE</a> + (<a class="code" href="behaviour__scan__beacons_8c.html#ad3732e0758d4aab3d0fb15edd48e0c6f">BEACON_GRID_SIZE</a> / 2);
<a name="l00066"></a>00066     pos.y = (<span class="keywordtype">id</span> &amp; 0xff) * <a class="code" href="behaviour__scan__beacons_8c.html#ad3732e0758d4aab3d0fb15edd48e0c6f">BEACON_GRID_SIZE</a> + (<a class="code" href="behaviour__scan__beacons_8c.html#ad3732e0758d4aab3d0fb15edd48e0c6f">BEACON_GRID_SIZE</a> / 2);
<a name="l00067"></a>00067 <span class="preprocessor">#else // MCU</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span>
<a name="l00069"></a>00069     <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {
<a name="l00070"></a>00070     <span class="keywordflow">case</span> 0xd:
<a name="l00071"></a>00071         pos.x = 0;
<a name="l00072"></a>00072         pos.y = 0;
<a name="l00073"></a>00073         <span class="keywordflow">break</span>;
<a name="l00074"></a>00074     <span class="keywordflow">case</span> 0xe:
<a name="l00075"></a>00075         pos.x = 1250;
<a name="l00076"></a>00076         pos.y = 0;
<a name="l00077"></a>00077         <span class="keywordflow">break</span>;
<a name="l00078"></a>00078     <span class="keywordflow">case</span> 0xc:
<a name="l00079"></a>00079         pos.x = 1250;
<a name="l00080"></a>00080         pos.y = 610;
<a name="l00081"></a>00081         <span class="keywordflow">break</span>;
<a name="l00082"></a>00082     }
<a name="l00083"></a>00083 <span class="preprocessor">#endif // PC</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085     <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;  Pos v. Landmarke %d: (%d|%d)&quot;</span>, <span class="keywordtype">id</span>, pos.x, pos.y);
<a name="l00086"></a>00086     <span class="keywordflow">return</span> pos;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00094"></a><a class="code" href="behaviour__scan__beacons_8h.html#ae0a6878672d5f846fd832ccf760cb2a6">00094</a> <span class="keywordtype">void</span> <a class="code" href="behaviour__scan__beacons_8c.html#ae0a6878672d5f846fd832ccf760cb2a6">bot_scan_beacons_behaviour</a>(<a class="code" href="struct__Behaviour__t.html" title="Verwaltungsstruktur fuer die Verhaltensroutinen.">Behaviour_t</a> * data) {
<a name="l00095"></a>00095     <span class="keyword">static</span> uint8_t disappeared_counter = 0;
<a name="l00096"></a>00096     <span class="keyword">static</span> uint16_t lastb_id = <a class="code" href="bot-local_8h.html#ab55267340d6da933fceb3af57a55445a">BPS_NO_DATA</a>;
<a name="l00097"></a>00097     <span class="keywordtype">float</span> diff = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a> - last_heading;
<a name="l00098"></a>00098 
<a name="l00099"></a>00099     <span class="keywordflow">switch</span> (state) {
<a name="l00100"></a>00100     <span class="keywordflow">case</span> <a class="code" href="behaviour__scan__beacons_8c.html#a62cdd89b7410c37225ca8abfc5251dde">SEARCH_APPEARANCE</a>:
<a name="l00101"></a>00101         last_heading = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a>;
<a name="l00102"></a>00102         <span class="keywordflow">if</span> (diff &lt; -2.0f) {
<a name="l00103"></a>00103             diff += 360.0f;
<a name="l00104"></a>00104         }
<a name="l00105"></a>00105         turned += diff;
<a name="l00106"></a>00106         <span class="keywordflow">if</span> (turned &gt; 360.0f) {
<a name="l00107"></a>00107             <span class="comment">/* Bot hat sich bereits um mehr als 360 Grad gedreht -&gt; Ende */</span>
<a name="l00108"></a>00108             state = <a class="code" href="behaviour__scan__beacons_8c.html#a29fd18bed01c4d836c7ebfe73a125c3f">END</a>;
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (<a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a> != <a class="code" href="bot-local_8h.html#ab55267340d6da933fceb3af57a55445a">BPS_NO_DATA</a>) {
<a name="l00112"></a>00112             <span class="comment">/* Landmarke erkannt */</span>
<a name="l00113"></a>00113             <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; BPS-Sensor meldet Landmarke:&quot;</span>);
<a name="l00114"></a>00114             <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;  ID=0x%x&quot;</span>, <a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a>);
<a name="l00115"></a>00115             uint8_t <a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>;
<a name="l00116"></a>00116             <span class="keywordflow">for</span> (i=0; i&lt;beacon_index; i++) {
<a name="l00117"></a>00117                 <span class="keywordflow">if</span> (recognized_beacons[i].<span class="keywordtype">id</span> == <a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a>) {
<a name="l00118"></a>00118                     <span class="comment">/* Diese Landmarke wurde bereits gesehen */</span>
<a name="l00119"></a>00119                     <span class="keywordflow">break</span>;
<a name="l00120"></a>00120                 }
<a name="l00121"></a>00121             }
<a name="l00122"></a>00122             <span class="keywordflow">if</span> (i == beacon_index) {
<a name="l00123"></a>00123                 <span class="comment">/* Neue Landmarke gefunden */</span>
<a name="l00124"></a>00124                 recognized_beacons[beacon_index].id = <a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a>;
<a name="l00125"></a>00125                 lastb_id = <a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a>;
<a name="l00126"></a>00126                 appearance_heading = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a>;
<a name="l00127"></a>00127                 disappeared_counter = 0;
<a name="l00128"></a>00128                 state = <a class="code" href="behaviour__scan__beacons_8c.html#accfb105ababa082863cb333c798a171f">SEARCH_DISAPPEARANCE</a>;
<a name="l00129"></a>00129                 <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; %u.Landmarke %d sichtbar ab %dG.&quot;</span>, beacon_index + 1, <a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a>, <a class="code" href="sensor_8c.html#a0bebab40bf945479d36e9190261b5a28">heading_int</a>);
<a name="l00130"></a>00130             }
<a name="l00131"></a>00131         }
<a name="l00132"></a>00132         <span class="keywordflow">break</span>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134     <span class="keywordflow">case</span> <a class="code" href="behaviour__scan__beacons_8c.html#accfb105ababa082863cb333c798a171f">SEARCH_DISAPPEARANCE</a>:
<a name="l00135"></a>00135         <span class="keywordflow">if</span> (<a class="code" href="sensor_8c.html#a34015652b96fbf2ceaca9b98b1715998">sensBPS</a> == <a class="code" href="bot-local_8h.html#ab55267340d6da933fceb3af57a55445a">BPS_NO_DATA</a>) {
<a name="l00136"></a>00136             disappeared_counter++;
<a name="l00137"></a>00137 <span class="preprocessor">#ifdef PC</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>            disappeared_counter = 3; <span class="comment">// im Sim kommt das Signal nicht gepulst, sondern dauerhaft</span>
<a name="l00139"></a>00139 <span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (disappeared_counter &gt; 1 <span class="comment">/*2*/</span>) {
<a name="l00141"></a>00141                 <span class="comment">/* Landmarke nicht mehr sichtbar */</span>
<a name="l00142"></a>00142                 <span class="keywordtype">float</span> diff = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a> - appearance_heading;
<a name="l00143"></a>00143                 <span class="keywordflow">if</span> (diff &lt; 0.0f) {
<a name="l00144"></a>00144                     diff += 360.0f;
<a name="l00145"></a>00145                 }
<a name="l00146"></a>00146                 last_beacon_heading = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a> - diff / 2.0f;
<a name="l00147"></a>00147                 <span class="keywordflow">if</span> (last_beacon_heading &lt; 0.0f) {
<a name="l00148"></a>00148                     last_beacon_heading += 360.0f;
<a name="l00149"></a>00149                 }
<a name="l00150"></a>00150                 <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; %u.Landmarke sichtbar bis %dG.&quot;</span>, beacon_index + 1, <a class="code" href="sensor_8c.html#a0bebab40bf945479d36e9190261b5a28">heading_int</a>);
<a name="l00151"></a>00151                 recognized_beacons[beacon_index].heading = last_beacon_heading;
<a name="l00152"></a>00152                 beacon_index++;
<a name="l00153"></a>00153                 <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;  Nehme %dG. als Richtung d. Landmarke&quot;</span>, (int16_t) last_beacon_heading);
<a name="l00154"></a>00154                 <span class="keywordflow">if</span> (beacon_index == <a class="code" href="behaviour__scan__beacons_8c.html#a82629da0b77dd188aa31e51bca0b8567">MAX_BEACONS</a>) {
<a name="l00155"></a>00155                     <span class="comment">/* maximale Anzahl an Landmarken erkannt */</span>
<a name="l00156"></a>00156                     state = <a class="code" href="behaviour__scan__beacons_8c.html#a9316b310ba918215b85c94167fce3659">CALC_POSITION</a>;
<a name="l00157"></a>00157                     <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; Berechne Position aus Landmarken&quot;</span>);
<a name="l00158"></a>00158                     <span class="comment">/* Bot stoppen */</span>
<a name="l00159"></a>00159                     <a class="code" href="bot-logic_8c.html#a20677c68ecbd2dc4f0de8ff553a01a3d" title="Puffervariable fuer die Verhaltensfunktionen absolute Geschwindigkeit links.">speedWishLeft</a> = <a class="code" href="motor_8h.html#a4c6e016f4c90744285145f136fcbf0c7" title="Motor aus.">BOT_SPEED_STOP</a>;
<a name="l00160"></a>00160                     <a class="code" href="bot-logic_8c.html#a65f056079c3d7ed3bc3eb90d46e92813" title="Puffervariable fuer die Verhaltensfunktionen absolute Geschwindigkeit rechts.">speedWishRight</a> = <a class="code" href="motor_8h.html#a4c6e016f4c90744285145f136fcbf0c7" title="Motor aus.">BOT_SPEED_STOP</a>;
<a name="l00161"></a>00161                 } <span class="keywordflow">else</span> {
<a name="l00162"></a>00162                     <span class="comment">/* naechste Landmarke suchen */</span>
<a name="l00163"></a>00163                     state = <a class="code" href="behaviour__scan__beacons_8c.html#a62cdd89b7410c37225ca8abfc5251dde">SEARCH_APPEARANCE</a>;
<a name="l00164"></a>00164                     <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;Suche %u. Landmarke...&quot;</span>, beacon_index + 1);
<a name="l00165"></a>00165                 }
<a name="l00166"></a>00166             }
<a name="l00167"></a>00167         } <span class="keywordflow">else</span> {
<a name="l00168"></a>00168             disappeared_counter = 0;
<a name="l00169"></a>00169         }
<a name="l00170"></a>00170         <span class="keywordflow">break</span>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <span class="keywordflow">case</span> <a class="code" href="behaviour__scan__beacons_8c.html#a9316b310ba918215b85c94167fce3659">CALC_POSITION</a>: {
<a name="l00173"></a>00173         <span class="comment">/* Drei oder mehr Landmarken gefunden, jetzt Position berechnen */</span>
<a name="l00174"></a>00174         position_t <a class="code" href="behaviour__drive__chess_8c.html#a24420a9beaac7cee08b5e255a4c29db1">a</a>, <a class="code" href="behaviour__drive__chess_8c.html#a7e6900841a67dbc908a8e0891b1f037f">m</a>, <a class="code" href="behaviour__drive__chess_8c.html#aea7fd00d09b3b311e2e48d7ee976c50e">b</a>, <a class="code" href="behaviour__drive__chess_8c.html#aa94ff7ddd304b9beb2f209b6174e180e">n</a>;
<a name="l00175"></a>00175         <span class="keywordtype">float</span> angle_am, angle_mb;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177         angle_am = recognized_beacons[2].heading - recognized_beacons[1].heading;
<a name="l00178"></a>00178         <span class="keywordflow">if</span> (angle_am &lt; 0.0f) {
<a name="l00179"></a>00179             angle_am += 360.0f;
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         angle_mb = recognized_beacons[1].heading - recognized_beacons[0].heading;
<a name="l00182"></a>00182         <span class="keywordflow">if</span> (angle_mb &lt; 0.0f) {
<a name="l00183"></a>00183             angle_mb += 360.0f;
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185 
<a name="l00187"></a>00187         <span class="keywordflow">if</span> (angle_am &gt; 180.0f) {
<a name="l00188"></a>00188             uint16_t tmp_id = recognized_beacons[2].id;
<a name="l00189"></a>00189             <span class="keywordtype">float</span> tmp_head = recognized_beacons[2].heading;
<a name="l00190"></a>00190             recognized_beacons[2] = recognized_beacons[1];
<a name="l00191"></a>00191             recognized_beacons[1] = recognized_beacons[0];
<a name="l00192"></a>00192             recognized_beacons[0].id = tmp_id;
<a name="l00193"></a>00193             recognized_beacons[0].heading = tmp_head;
<a name="l00194"></a>00194             angle_am = recognized_beacons[2].heading - recognized_beacons[1].heading;
<a name="l00195"></a>00195             <span class="keywordflow">if</span> (angle_am &lt; 0.0f) {
<a name="l00196"></a>00196                 angle_am += 360.0f;
<a name="l00197"></a>00197             }
<a name="l00198"></a>00198             angle_mb = recognized_beacons[1].heading - recognized_beacons[0].heading;
<a name="l00199"></a>00199             <span class="keywordflow">if</span> (angle_mb &lt; 0.0f) {
<a name="l00200"></a>00200                 angle_mb += 360.0f;
<a name="l00201"></a>00201             }
<a name="l00202"></a>00202         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (angle_mb &gt; 180.0f) {
<a name="l00203"></a>00203             uint16_t tmp_id = recognized_beacons[2].id;
<a name="l00204"></a>00204             <span class="keywordtype">float</span> tmp_head = recognized_beacons[2].heading;
<a name="l00205"></a>00205             recognized_beacons[2] = recognized_beacons[0];
<a name="l00206"></a>00206             recognized_beacons[0] = recognized_beacons[1];
<a name="l00207"></a>00207             recognized_beacons[1].id = tmp_id;
<a name="l00208"></a>00208             recognized_beacons[1].heading = tmp_head;
<a name="l00209"></a>00209             angle_am = recognized_beacons[2].heading - recognized_beacons[1].heading;
<a name="l00210"></a>00210             <span class="keywordflow">if</span> (angle_am &lt; 0.0f) {
<a name="l00211"></a>00211                 angle_am += 360.0f;
<a name="l00212"></a>00212             }
<a name="l00213"></a>00213             angle_mb = recognized_beacons[1].heading - recognized_beacons[0].heading;
<a name="l00214"></a>00214             <span class="keywordflow">if</span> (angle_mb &lt; 0.0f) {
<a name="l00215"></a>00215                 angle_mb += 360.0f;
<a name="l00216"></a>00216             }
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219         a = get_position_from_id(recognized_beacons[2].<span class="keywordtype">id</span>);
<a name="l00220"></a>00220         m = get_position_from_id(recognized_beacons[1].<span class="keywordtype">id</span>);
<a name="l00221"></a>00221         b = get_position_from_id(recognized_beacons[0].<span class="keywordtype">id</span>);
<a name="l00222"></a>00222 
<a name="l00223"></a>00223         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; A=(%d|%d) M=(%d|%d) B=(%d|%d)&quot;</span>, a.x, a.y, m.x, m.y, b.x, b.y);
<a name="l00224"></a>00224         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; angle_am=%d; angle_mb=%d&quot;</span>, (int16_t) angle_am, (int16_t) angle_mb);
<a name="l00225"></a>00225         n = <a class="code" href="math__utils_8c.html#a8b0e0e0cb5958042f543a326a68a0a40" title="Berechnet den Standort via Rueckwaertseinschnitt nach Cassini, wenn drei angepeilte Positionen bekann...">calc_resection</a>(a, m, b, angle_am, angle_mb);
<a name="l00226"></a>00226         position_t last_beacon = get_position_from_id(lastb_id);
<a name="l00227"></a>00227         <span class="keywordtype">float</span> head = atan2f(last_beacon.y - n.y, last_beacon.x - n.x);
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (head &lt; 0) {
<a name="l00229"></a>00229             head += (2.0f * <a class="code" href="global_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>);
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231         head = fmodf(head + <a class="code" href="global_8h.html#a958e4508ed28ee5cc04249144312c15f" title="pi / 2">M_PI_2</a>, 2.0f * <a class="code" href="global_8h.html#ae71449b1cc6e6250b91f539153a7a0d3">M_PI</a>); <span class="comment">// Sensor zeigt nach -90 Grad</span>
<a name="l00232"></a>00232         <span class="keywordflow">if</span> (turn_mode == 1) {
<a name="l00233"></a>00233             <span class="comment">/* Botmittelpunkt berechnen aus Position des linken Rades */</span>
<a name="l00234"></a>00234             <span class="keyword">const</span> <span class="keywordtype">float</span> dX = sinf(head) * (<a class="code" href="bot-local_8h.html#abcfe4118c97f0329b4b341e5efb5f720">WHEEL_TO_WHEEL_DIAMETER</a> / 2.0f);
<a name="l00235"></a>00235             <span class="keyword">const</span> <span class="keywordtype">float</span> dY = cosf(head) * (<a class="code" href="bot-local_8h.html#abcfe4118c97f0329b4b341e5efb5f720">WHEEL_TO_WHEEL_DIAMETER</a> / 2.0f);
<a name="l00236"></a>00236             n.x += iroundf(dX);
<a name="l00237"></a>00237             n.y += iroundf(dY);
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239         head = deg(head);
<a name="l00240"></a>00240         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; &gt; Berechnete Position: (%d|%d)&quot;</span>, n.x, n.y);
<a name="l00241"></a>00241         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; &gt;  Heading: %d&quot;</span>, (int16_t) head);
<a name="l00242"></a>00242         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; &gt; Bisherige Position: (%d|%d)&quot;</span>, <a class="code" href="sensor_8c.html#ac5ae500a2280ad6ed571a99a11954492">x_pos</a>, <a class="code" href="sensor_8c.html#a82663881f9567f6bf0b697b77af08d0d">y_pos</a>);
<a name="l00243"></a>00243         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; &gt;  Heading: %d&quot;</span>, (int16_t) last_beacon_heading);
<a name="l00244"></a>00244 
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (pos_update != 1) {
<a name="l00246"></a>00246             <span class="comment">/* kein Positionsupdate gewuenscht */</span>
<a name="l00247"></a>00247             state = <a class="code" href="behaviour__scan__beacons_8c.html#a29fd18bed01c4d836c7ebfe73a125c3f">END</a>;
<a name="l00248"></a>00248             <span class="keywordflow">return</span>;
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="comment">/* Position des Bots auf die gerade Berechnete setzen */</span>
<a name="l00252"></a>00252         <span class="keywordflow">if</span> (n.x != INT16_MAX &amp;&amp; n.y != INT16_MAX) {
<a name="l00253"></a>00253             <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot; Aktualisiere Positionsdaten&quot;</span>);
<a name="l00254"></a>00254             <a class="code" href="sensor_8c.html#ac5ae500a2280ad6ed571a99a11954492">x_pos</a> = n.x;
<a name="l00255"></a>00255             <a class="code" href="sensor_8c.html#a82663881f9567f6bf0b697b77af08d0d">y_pos</a> = n.y;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257             <span class="keywordtype">float</span> head_diff = head - last_beacon_heading;
<a name="l00258"></a>00258             <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a> = fmodf(<a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a> + head_diff, 360.0f);
<a name="l00259"></a>00259             <a class="code" href="sensor_8c.html#a73a97a07a62a59c874745743912aaf8b">x_enc</a> = n.x;
<a name="l00260"></a>00260             <a class="code" href="sensor_8c.html#acf8b5e7623be6575742e3edf304fd010">y_enc</a> = n.y;
<a name="l00261"></a>00261             <a class="code" href="sensor_8c.html#a939a9b8951bd499bba3d184f3287df59">heading_enc</a> = fmodf(<a class="code" href="sensor_8c.html#a939a9b8951bd499bba3d184f3287df59">heading_enc</a> + head_diff, 360.0f);
<a name="l00262"></a>00262 <span class="preprocessor">#ifdef MEASURE_MOUSE_AVAILABLE</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>            <a class="code" href="sensor_8c.html#a0d1b34e787bce8bf663991ecc52993f3">x_mou</a> = n.x;
<a name="l00264"></a>00264             <a class="code" href="sensor_8c.html#a98702ab3fa708015b7f0ece9bb6e7829">y_mou</a> = n.y;
<a name="l00265"></a>00265             <a class="code" href="sensor_8c.html#afe11ed1b60135e873bb810ab6d513f98">heading_mou</a> = fmodf(<a class="code" href="sensor_8c.html#afe11ed1b60135e873bb810ab6d513f98">heading_mou</a> + head_diff, 360.0f);
<a name="l00266"></a>00266 <span class="preprocessor">#endif // MEASURE_MOUSE_AVAILABLE</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span>        }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         state = <a class="code" href="behaviour__scan__beacons_8c.html#a29fd18bed01c4d836c7ebfe73a125c3f">END</a>;
<a name="l00270"></a>00270         <span class="keywordflow">break</span>;
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     <span class="keywordflow">default</span>:
<a name="l00274"></a>00274         <span class="comment">/* Ende */</span>
<a name="l00275"></a>00275         <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;Suche nach Landmarken beendet&quot;</span>);
<a name="l00276"></a>00276         return_from_behaviour(data);
<a name="l00277"></a>00277         <span class="keywordflow">return</span>;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279     <span class="comment">/* Bot drehen */</span>
<a name="l00280"></a>00280     <a class="code" href="bot-logic_8c.html#a65f056079c3d7ed3bc3eb90d46e92813" title="Puffervariable fuer die Verhaltensfunktionen absolute Geschwindigkeit rechts.">speedWishRight</a> = <a class="code" href="motor_8h.html#a9bad693d07105ebfddf9d9b0e5da9f97" title="langsamste Fahrt in mm/s">BOT_SPEED_MIN</a>;
<a name="l00281"></a>00281     <span class="keywordflow">if</span> (turn_mode == 0) {
<a name="l00282"></a>00282         <a class="code" href="bot-logic_8c.html#a20677c68ecbd2dc4f0de8ff553a01a3d" title="Puffervariable fuer die Verhaltensfunktionen absolute Geschwindigkeit links.">speedWishLeft</a> = -<a class="code" href="motor_8h.html#a9bad693d07105ebfddf9d9b0e5da9f97" title="langsamste Fahrt in mm/s">BOT_SPEED_MIN</a>;
<a name="l00283"></a>00283     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (turn_mode == 1) {
<a name="l00284"></a>00284         <a class="code" href="bot-logic_8c.html#a20677c68ecbd2dc4f0de8ff553a01a3d" title="Puffervariable fuer die Verhaltensfunktionen absolute Geschwindigkeit links.">speedWishLeft</a>  = <a class="code" href="motor_8h.html#a4c6e016f4c90744285145f136fcbf0c7" title="Motor aus.">BOT_SPEED_STOP</a>;
<a name="l00285"></a>00285     }
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 
<a name="l00295"></a><a class="code" href="behaviour__scan__beacons_8h.html#a5a3cdbacd1818b665d46ad7c502ecfad">00295</a> <span class="keywordtype">void</span> <a class="code" href="behaviour__scan__beacons_8c.html#a5a3cdbacd1818b665d46ad7c502ecfad">bot_scan_beacons</a>(<a class="code" href="struct__Behaviour__t.html" title="Verwaltungsstruktur fuer die Verhaltensroutinen.">Behaviour_t</a> * caller, uint8_t position_update, uint8_t mode) {
<a name="l00296"></a>00296     pos_update = position_update;
<a name="l00297"></a>00297     turn_mode = mode;
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (mode &gt; 1) {
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (caller != NULL) {
<a name="l00300"></a>00300             caller-&gt;<a class="code" href="struct__Behaviour__t.html#ac854c181b7e05da0fdc40a5c70547054" title="War das aufgerufene Unterverhalten erfolgreich (==1)?">subResult</a> = <a class="code" href="bot-logic_8h.html#a78d9ef1511522ee147d2d386a584a5d7" title="Konstante fuer Behaviour_t-&gt;subResult: Aufgabe nicht abgeschlossen.">BEHAVIOUR_SUBFAIL</a>;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">return</span>;
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304     <a class="code" href="bot-logic_8c.html#a123152ecfcd89545c2603cb3f2e873c9" title="Ruft ein anderes Verhalten auf und merkt sich den Ruecksprung return_from_behaviour() kehrt dann spae...">switch_to_behaviour</a>(caller, <a class="code" href="behaviour__scan__beacons_8c.html#ae0a6878672d5f846fd832ccf760cb2a6">bot_scan_beacons_behaviour</a>, <a class="code" href="bot-logic_8h.html#ac3101d6686d35c952f2a5c8177b3f262" title="Konstante, wenn Verhalten beim Aufruf alte Wuensche ueberschreiben sollen.">BEHAVIOUR_OVERRIDE</a>);
<a name="l00305"></a>00305     state = <a class="code" href="behaviour__scan__beacons_8c.html#a62cdd89b7410c37225ca8abfc5251dde">SEARCH_APPEARANCE</a>;
<a name="l00306"></a>00306     beacon_index = 0;
<a name="l00307"></a>00307     turned = 0.0f;
<a name="l00308"></a>00308     last_heading = <a class="code" href="sensor_8c.html#ac5682e48513a771560df50e3b213e61a">heading</a>;
<a name="l00309"></a>00309     int8_t <a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>;
<a name="l00310"></a>00310     <span class="comment">/* Landmarken-Speicher leeren */</span>
<a name="l00311"></a>00311     <span class="keywordflow">for</span> (i=<a class="code" href="behaviour__scan__beacons_8c.html#a82629da0b77dd188aa31e51bca0b8567">MAX_BEACONS</a>-1; i&gt;=0; i--) {
<a name="l00312"></a>00312         recognized_beacons[<a class="code" href="behaviour__drive__chess_8c.html#a9aa40e637eff435d9abc0f4dc467b6bb">i</a>].id = <a class="code" href="bot-local_8h.html#ab55267340d6da933fceb3af57a55445a">BPS_NO_DATA</a>;
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314     <a class="code" href="command_8c.html#a754b3d074e0af4ad3c7b918dd77ecb2d" title="Log-Dummy.">LOG_DEBUG</a>(<span class="stringliteral">&quot;Suche 1. Landmarke...&quot;</span>);
<a name="l00315"></a>00315 }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317 <span class="preprocessor">#endif // BEHAVIOUR_SCAN_BEACONS_AVAILABLE</span>
</pre></div></div>
</div>


<hr class="footer"/><address class="footer"><small>
Erzeugt am Mit Feb 29 2012 14:18:08 f√ºr c't-Bot von &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5.1
</small></address>

</body>
</html>
